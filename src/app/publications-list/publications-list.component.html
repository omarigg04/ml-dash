<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">Mis Publicaciones</h1>
  <p class="page-description">Gestiona tus productos publicados en MercadoLibre</p>
</div>

<!-- Filters and Search Card -->
<div class="card filters-card">
  <div class="filters-header">
    <mat-icon>filter_list</mat-icon>
    <h3>Filtros y Búsqueda</h3>
    <button *ngIf="hasActiveFilters()" class="btn-clear-filters" (click)="clearFilters()">
      <mat-icon>clear_all</mat-icon>
      Limpiar filtros
    </button>
  </div>

  <div class="filters-body">
    <!-- Search Bar -->
    <div class="filter-group search-group">
      <label class="filter-label">Buscar</label>
      <div class="search-input-wrapper">
        <mat-icon class="search-icon">search</mat-icon>
        <input type="text" class="search-input" [(ngModel)]="searchQuery" (keyup.enter)="onSearch()"
          placeholder="Buscar por título...">
        <button *ngIf="searchQuery" class="btn-clear-search" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
        <button class="btn-search" (click)="onSearch()">
          Buscar
        </button>
      </div>
    </div>

    <!-- Filter Controls -->
    <div class="filters-row">
      <!-- Status Filter -->
      <div class="filter-group">
        <label class="filter-label" for="statusFilter">Estado</label>
        <select id="statusFilter" class="filter-select" [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option *ngFor="let option of statusOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Listing Type Filter -->
      <div class="filter-group">
        <label class="filter-label" for="listingTypeFilter">Tipo de Publicación</label>
        <select id="listingTypeFilter" class="filter-select" [(ngModel)]="listingTypeFilter"
          (change)="onListingTypeFilterChange()">
          <option *ngFor="let option of listingTypeOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>

      <!-- Sort -->
      <div class="filter-group">
        <label class="filter-label" for="sortFilter">Ordenar por</label>
        <select id="sortFilter" class="filter-select" [(ngModel)]="sortBy" (change)="onSortChange()">
          <option *ngFor="let option of sortOptions" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary" *ngIf="!isLoading">
    <mat-icon>inventory</mat-icon>
    <span>
      Mostrando {{ dataSource.length }} de {{ totalItems }} publicaciones
    </span>
  </div>
</div>

<!-- Table Card -->
<div class="card table-card">
  <div class="table-container">
    <mat-spinner *ngIf="isLoading" diameter="50" class="table-spinner"></mat-spinner>

    <table *ngIf="!isLoading" mat-table [dataSource]="dataSource" class="publications-table">

      <!-- Thumbnail Column -->
      <ng-container matColumnDef="thumbnail">
        <th mat-header-cell *matHeaderCellDef>Imagen</th>
        <td mat-cell *matCellDef="let item">
          <img *ngIf="item.thumbnail"
               [src]="item.thumbnail"
               (error)="onImageError(item)"
               alt="Thumbnail"
               class="thumbnail-image" />
          <div *ngIf="!item.thumbnail" class="thumbnail-placeholder">
            <mat-icon>question_mark</mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Title Column -->
      <ng-container matColumnDef="title">
        <th mat-header-cell *matHeaderCellDef>Título</th>
        <td mat-cell *matCellDef="let item" class="title-cell">
          <div class="title-content">
            <span class="title-text">{{ item.title }}</span>
          </div>
        </td>
      </ng-container>

      <!-- Price Column -->
      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Precio</th>
        <td mat-cell *matCellDef="let item">
          <span class="price-value">${{ item.price | number:'1.2-2' }}</span>
          <span class="price-currency">MXN</span>
        </td>
      </ng-container>

      <!-- Stock Column -->
      <ng-container matColumnDef="stock">
        <th mat-header-cell *matHeaderCellDef>Stock</th>
        <td mat-cell *matCellDef="let item">
          <span class="stock-value">{{ item.available_quantity }}</span>
        </td>
      </ng-container>

      <!-- Visits Column -->
      <ng-container matColumnDef="visits">
        <th mat-header-cell *matHeaderCellDef>Vistas</th>
        <td mat-cell *matCellDef="let item">
          <div class="visits-container">
            <mat-icon class="visits-icon">visibility</mat-icon>
            <span class="visits-value" *ngIf="!isLoadingVisits">{{ item.visits || 0 }}</span>
            <mat-spinner *ngIf="isLoadingVisits" diameter="16" class="visits-spinner"></mat-spinner>
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Estado</th>
        <td mat-cell *matCellDef="let item">
          <span class="status-badge" [ngClass]="'status-' + item.status">
            <span class="status-text">{{ getStatusLabel(item.status) }}</span>
            <mat-icon class="status-icon">{{ getStatusIcon(item.status) }}</mat-icon>
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let item">
          <div class="action-buttons">
            <button mat-button class="btn-action btn-duplicate" (click)="onDuplicate(item)"
              matTooltip="Duplicar publicación">
              <mat-icon>content_copy</mat-icon>
            </button>

            <button mat-button class="btn-action btn-edit" matTooltip="Editar publicación">
              <mat-icon>edit</mat-icon>
            </button>

            <button mat-icon-button class="btn-icon-action" (click)="onViewDetails(item)" matTooltip="Ver detalles">
              <mat-icon>visibility</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns; trackBy: trackByItemId" class="table-row"></tr>
    </table>

    <div *ngIf="!isLoading && dataSource.length === 0" class="no-data">
      <mat-icon class="no-data-icon">inventory_2</mat-icon>
      <p class="no-data-text">No hay publicaciones para mostrar</p>
      <p class="no-data-hint" *ngIf="hasActiveFilters()">
        Intenta ajustar tus filtros de búsqueda
      </p>
      <p class="no-data-hint" *ngIf="!hasActiveFilters()">
        Crea tu primera publicación para comenzar
      </p>
    </div>
  </div>

  <!-- Load More Button -->
  <div class="pagination-section" *ngIf="!isLoading && dataSource.length > 0">
    <button *ngIf="hasMore" class="btn-load-more" (click)="loadMore()" [disabled]="isLoadingMore">
      <mat-spinner *ngIf="isLoadingMore" diameter="20" class="btn-spinner"></mat-spinner>
      <mat-icon *ngIf="!isLoadingMore">expand_more</mat-icon>
      {{ isLoadingMore ? 'Cargando...' : 'Cargar más publicaciones' }}
    </button>

    <p class="pagination-info" *ngIf="!hasMore && totalItems > pageSize">
      Has visto todas las publicaciones ({{ totalItems }} total)
    </p>
  </div>
</div>