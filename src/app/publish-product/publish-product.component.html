<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title">Publicar Producto</h1>
  <p class="page-description">Crea una nueva publicaci칩n en MercadoLibre</p>
</div>

<!-- Success Message -->
<div *ngIf="successMessage" class="alert alert-success">
  <mat-icon class="alert-icon">check_circle</mat-icon>
  <span>{{ successMessage }}</span>
  <button type="button" class="alert-close" (click)="successMessage = ''">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Error Message -->
<div *ngIf="errorMessage" class="alert alert-error">
  <mat-icon class="alert-icon">error</mat-icon>
  <span>{{ errorMessage }}</span>
  <button type="button" class="alert-close" (click)="errorMessage = ''">
    <mat-icon>close</mat-icon>
  </button>
</div>

<!-- Form Card -->
<div class="card form-card">
  <div class="form-header">
    <div class="form-header-content">
      <mat-icon class="form-icon">inventory_2</mat-icon>
      <div>
        <h3 class="form-title">Informaci칩n del Producto</h3>
        <p class="form-subtitle">Complete los detalles de su publicaci칩n</p>
      </div>
    </div>
  </div>

  <div class="form-body">
    <form (ngSubmit)="onSubmit()" #productForm="ngForm">

      <!-- Category Template Selector -->
      <div *ngIf="!isDuplicateMode" class="form-section">
        <div class="form-section-header">
          <mat-icon>label</mat-icon>
          <h4>Seleccionar Categor칤a de Producto</h4>
        </div>

        <div *ngIf="isDuplicateMode" class="duplicate-mode-alert">
          <mat-icon>content_copy</mat-icon>
          <span>Modo Duplicaci칩n: La categor칤a est치 fijada seg칰n el producto duplicado</span>
        </div>

        <div class="form-group">
          <select class="form-select"
                  [(ngModel)]="selectedCategoryId"
                  name="category_selector"
                  (change)="onCategoryChange(selectedCategoryId)"
                  [disabled]="isDuplicateMode"
                  [required]="!isDuplicateMode">
            <option *ngFor="let template of categoryTemplates" [value]="template.id">
              {{ template.name }} - {{ template.description }}
            </option>
          </select>
          <small class="form-hint">
            <span *ngIf="!isDuplicateMode">Selecciona el tipo de producto que deseas publicar. Los campos se ajustar치n autom치ticamente.</span>
            <span *ngIf="isDuplicateMode">Los datos del producto duplicado se han cargado autom치ticamente.</span>
          </small>
        </div>
      </div>

      <!-- Product Details Form (for Transistors) -->
      <div *ngIf="product">

        <div class="form-section">
          <div class="form-section-header">
            <mat-icon>build</mat-icon>
            <h4>Informaci칩n del Transistor</h4>
          </div>

          <!-- Family Name -->
          <div class="form-group">
            <label for="family_name" class="form-label">
              Nombre del Producto *
              <span *ngIf="isLoadingPredictions" class="loading-indicator">
                <mat-spinner diameter="16"></mat-spinner> Prediciendo categor칤a...
              </span>
            </label>
            <input type="text"
                   class="form-input"
                   id="family_name"
                   name="family_name"
                   [(ngModel)]="product.family_name"
                   (ngModelChange)="onProductNameChange($event)"
                   required
                   maxlength="60"
                   placeholder="Ej: Transistor NPN 2N3055">
            <small class="form-hint">
              MercadoLibre generar치 autom치ticamente el t칤tulo basado en este nombre y los atributos (m치x. 60 caracteres)
              <br>
              游눠 Escribe el nombre del producto y te sugeriremos la categor칤a autom치ticamente
            </small>

            <!-- Category Predictions Panel -->
            <div *ngIf="showCategoryPredictions" class="category-predictions-panel">
              <div class="predictions-header">
                <h4>
                  <mat-icon>lightbulb</mat-icon>
                  Categor칤as Sugeridas
                </h4>
                <button type="button"
                        class="close-btn"
                        (click)="closeCategoryPredictions()">
                  <mat-icon>close</mat-icon>
                </button>
              </div>

              <div class="predictions-list">
                <div *ngFor="let prediction of categoryPredictions"
                     class="prediction-item"
                     (click)="selectPredictedCategory(prediction)">
                  <div class="prediction-content">
                    <div class="prediction-category">
                      <mat-icon>category</mat-icon>
                      <strong>{{ prediction.category_name }}</strong>
                    </div>
                    <div class="prediction-domain">
                      {{ prediction.domain_name }}
                    </div>
                    <div class="prediction-id">
                      ID: {{ prediction.category_id }}
                    </div>
                  </div>
                  <mat-icon class="select-icon">arrow_forward</mat-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- Description -->
          <div class="form-group">
            <label for="description" class="form-label">Descripci칩n del Producto</label>
            <textarea class="form-textarea"
                      id="description"
                      name="description"
                      [(ngModel)]="product.description"
                      rows="6"
                      maxlength="50000"
                      placeholder="Descripci칩n detallada del producto. Puedes incluir caracter칤sticas, especificaciones t칠cnicas, garant칤a, etc."></textarea>
            <small class="form-hint">
              Descripci칩n completa del producto. M치ximo 50,000 caracteres. Puedes usar texto plano o HTML b치sico.
            </small>
          </div>

          <!-- Price & Stock Row -->
          <div class="form-row">
            <div class="form-group">
              <label for="price" class="form-label">Precio (MXN) *</label>
              <input type="number"
                     class="form-input"
                     id="price"
                     name="price"
                     [(ngModel)]="product.price"
                     required
                     min="0"
                     step="0.01"
                     placeholder="350.00">
            </div>
            <div class="form-group">
              <label for="stock" class="form-label">Cantidad Disponible *</label>
              <input type="number"
                     class="form-input"
                     id="stock"
                     name="available_quantity"
                     [(ngModel)]="product.available_quantity"
                     required
                     min="1"
                     placeholder="10">
            </div>
          </div>

          <!-- Condition & Listing Type Row -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Condici칩n *</label>
              <select class="form-select"
                      name="condition"
                      [(ngModel)]="product.condition"
                      required>
                <option value="new">Nuevo</option>
                <option value="used">Usado</option>
                <option value="refurbished">Reacondicionado</option>
              </select>
            </div>
            <div class="form-group">
              <label for="listingType" class="form-label">Tipo de Publicaci칩n</label>
              <select class="form-select"
                      id="listingType"
                      name="listing_type_id"
                      [(ngModel)]="product.listing_type_id">
                <option *ngFor="let type of listingTypes" [value]="type.id">
                  {{ type.name }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Attributes Section -->
        <div class="form-section">
          <div class="form-section-header">
            <mat-icon>edit_note</mat-icon>
            <h4>Atributos del Transistor</h4>
          </div>

          <div class="attributes-container">
            <div *ngIf="product.attributes && product.attributes.length > 0">
              <div *ngFor="let attr of product.attributes; let i = index" class="attribute-item">
                <div class="form-row attribute-row">
                  <div class="form-group">
                    <label class="form-label">ID del Atributo</label>
                    <input type="text"
                           class="form-input form-input-sm"
                           [(ngModel)]="attr.id"
                           [name]="'attr_id_' + i"
                           placeholder="Ej: BRAND, MODEL">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Nombre</label>
                    <input type="text"
                           class="form-input form-input-sm"
                           [(ngModel)]="attr.name"
                           [name]="'attr_name_' + i"
                           placeholder="Ej: Marca">
                  </div>
                  <div class="form-group">
                    <label class="form-label">Valor</label>
                    <input type="text"
                           class="form-input form-input-sm"
                           [(ngModel)]="attr.value_name"
                           [name]="'attr_value_' + i"
                           placeholder="Ej: Gen칠rica">
                  </div>
                  <div class="form-group attribute-action">
                    <label class="form-label">&nbsp;</label>
                    <button type="button"
                            class="btn-icon btn-destructive"
                            (click)="removeAttribute(i)">
                      <mat-icon>delete</mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <button type="button"
                    class="btn-outline"
                    (click)="addAttribute()">
              <mat-icon>add</mat-icon>
              A침adir Atributo
            </button>
          </div>
        </div>

        <!-- Sale Terms (Warranty) -->
        <div class="form-section" *ngIf="product.sale_terms && product.sale_terms.length > 0">
          <div class="form-section-header">
            <mat-icon>verified_user</mat-icon>
            <h4>Garant칤a</h4>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tipo de Garant칤a</label>
              <input type="text"
                     class="form-input"
                     [(ngModel)]="product.sale_terms[0].value_name"
                     name="warranty_type_value"
                     placeholder="Ej: Garant칤a del vendedor">
            </div>
            <div class="form-group">
              <label class="form-label">Tiempo de Garant칤a</label>
              <input type="text"
                     class="form-input"
                     [(ngModel)]="product.sale_terms[1].value_name"
                     name="warranty_time_value"
                     placeholder="Ej: 90 d칤as">
            </div>
          </div>
        </div>

        <!-- Pictures URLs -->
        <div class="form-section">
          <div class="form-section-header">
            <mat-icon>image</mat-icon>
            <h4>Im치genes del Producto</h4>
          </div>

          <div class="form-group">
            <app-image-source-selector
              [categoryId]="product.category_id"
              [itemTitle]="product.family_name"
              [initialImages]="originalItemImages"
              [maxImages]="10"
              (onImagesValidated)="handleImagesValidated($event)">
            </app-image-source-selector>

            <small class="form-hint">
              Puedes subir im치genes nuevas, seleccionar de tu galer칤a, o usar URLs directas.
              Las im치genes ser치n validadas autom치ticamente antes de publicar.
            </small>
          </div>

          <!-- Fallback: Textarea para URLs (mantener para compatibilidad) -->
          <details class="legacy-input">
            <summary>O pegar URLs manualmente (m칠todo antiguo)</summary>
            <div class="form-group">
              <label for="pictures" class="form-label">URLs de Im치genes</label>
              <textarea class="form-textarea"
                        id="pictures"
                        name="pictures_text"
                        [(ngModel)]="picturesText"
                        rows="4"
                        placeholder="http://ejemplo.com/imagen1.jpg&#10;http://ejemplo.com/imagen2.jpg&#10;Una URL por l칤nea"></textarea>
              <small class="form-hint">Una URL por l칤nea. M치ximo 10 im치genes.</small>
            </div>
          </details>
        </div>

        <!-- Shipping Info -->
        <div class="form-section" *ngIf="product.shipping">
          <div class="form-section-header">
            <mat-icon>local_shipping</mat-icon>
            <h4>Configuraci칩n de Env칤o</h4>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Modo de Env칤o</label>
              <input type="text"
                     class="form-input"
                     [(ngModel)]="product.shipping.mode"
                     name="shipping_mode"
                     placeholder="Ej: me1">
            </div>
            <div class="form-group">
              <div class="form-checkbox">
                <input class="checkbox-input"
                       type="checkbox"
                       [(ngModel)]="product.shipping.free_shipping"
                       name="free_shipping"
                       id="freeShipping">
                <label class="checkbox-label" for="freeShipping">
                  Env칤o Gratis
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Tipo Log칤stico</label>
              <input type="text"
                     class="form-input"
                     [(ngModel)]="product.shipping.logistic_type"
                     name="logistic_type"
                     placeholder="Ej: xd_drop_off">
            </div>
          </div>
        </div>

      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button"
                class="btn-secondary"
                (click)="resetForm()"
                [disabled]="loading">
          <mat-icon>refresh</mat-icon>
          Resetear
        </button>
        <button type="submit"
                class="btn-primary btn-publish"
                [disabled]="!productForm.valid || loading">
          <mat-spinner *ngIf="loading" diameter="20" class="btn-spinner"></mat-spinner>
          <mat-icon *ngIf="!loading">rocket_launch</mat-icon>
          {{ loading ? 'Publicando...' : 'Publicar Producto' }}
        </button>
      </div>

    </form>
  </div>
</div>

<!-- Info Card -->
<div class="card info-card">
  <div class="info-header">
    <mat-icon>info</mat-icon>
    <h4>Informaci칩n</h4>
  </div>
  <ul class="info-list">
    <li>Los campos se ajustan autom치ticamente seg칰n la categor칤a seleccionada</li>
    <li>MercadoLibre genera el t칤tulo autom치ticamente bas치ndose en el nombre y atributos del producto</li>
    <li>Aseg칰rate de completar todos los atributos requeridos para evitar errores de validaci칩n</li>
    <li>El template se resetea autom치ticamente despu칠s de publicar exitosamente</li>
  </ul>
</div>
