<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0">üì¶ Publicar Producto en MercadoLibre</h3>
                </div>
                <div class="card-body">

                    <!-- Success Message -->
                    <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
                        <strong>‚úÖ {{ successMessage }}</strong>
                        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
                    </div>

                    <!-- Error Message -->
                    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                        <strong>‚ùå {{ errorMessage }}</strong>
                        <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
                    </div>

                    <form (ngSubmit)="onSubmit()" #productForm="ngForm">

                        <!-- Category Template Selector -->
                        <div class="mb-4 p-3 border rounded" [ngClass]="isDuplicateMode ? 'bg-secondary-subtle' : 'bg-light'">
                            <label class="form-label fw-bold">üè∑Ô∏è Seleccionar Categor√≠a de Producto</label>
                            <div *ngIf="isDuplicateMode" class="alert alert-info mb-2">
                                <small>üìã Modo Duplicaci√≥n: La categor√≠a est√° fijada seg√∫n el producto duplicado</small>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <select class="form-select form-select-lg"
                                            [(ngModel)]="selectedCategoryId"
                                            name="category_selector"
                                            (change)="onCategoryChange(selectedCategoryId)"
                                            [disabled]="isDuplicateMode"
                                            [required]="!isDuplicateMode">
                                        <option *ngFor="let template of categoryTemplates" [value]="template.id">
                                            {{ template.name }} - {{ template.description }}
                                        </option>
                                    </select>
                                    <small class="form-text text-muted mt-2 d-block">
                                        <span *ngIf="!isDuplicateMode">Selecciona el tipo de producto que deseas publicar. Los campos se ajustar√°n autom√°ticamente.</span>
                                        <span *ngIf="isDuplicateMode">Los datos del producto duplicado se han cargado autom√°ticamente.</span>
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Formulario para Transistores -->
                        <div *ngIf="selectedCategoryId === 'MLM187825'">

                            <h5 class="mb-3 text-primary">üîß Informaci√≥n del Transistor</h5>

                            <!-- Family Name (Nombre del Producto) -->
                            <div class="mb-3">
                                <label for="family_name" class="form-label">Nombre del Producto *</label>
                                <input type="text"
                                       class="form-control"
                                       id="family_name"
                                       name="family_name"
                                       [(ngModel)]="product.family_name"
                                       required
                                       placeholder="Ej: Transistor NPN 2N3055">
                                <small class="form-text text-muted">
                                    MercadoLibre generar√° autom√°ticamente el t√≠tulo basado en este nombre y los atributos
                                </small>
                            </div>

                            <!-- Price & Stock Row -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="price" class="form-label">Precio (MXN) *</label>
                                    <input type="number"
                                           class="form-control"
                                           id="price"
                                           name="price"
                                           [(ngModel)]="product.price"
                                           required
                                           min="0"
                                           step="0.01"
                                           placeholder="350.00">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="stock" class="form-label">Cantidad Disponible *</label>
                                    <input type="number"
                                           class="form-control"
                                           id="stock"
                                           name="available_quantity"
                                           [(ngModel)]="product.available_quantity"
                                           required
                                           min="1"
                                           placeholder="10">
                                </div>
                            </div>

                            <!-- Condition & Listing Type Row -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Condici√≥n *</label>
                                    <select class="form-select"
                                            name="condition"
                                            [(ngModel)]="product.condition"
                                            required>
                                        <option value="new">Nuevo</option>
                                        <option value="used">Usado</option>
                                        <option value="refurbished">Reacondicionado</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="listingType" class="form-label">Tipo de Publicaci√≥n</label>
                                    <select class="form-select"
                                            id="listingType"
                                            name="listing_type_id"
                                            [(ngModel)]="product.listing_type_id">
                                        <option *ngFor="let type of listingTypes" [value]="type.id">
                                            {{ type.name }}
                                        </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Attributes Section -->
                            <div class="mb-4">
                                <h6 class="mb-3">üìù Atributos del Transistor</h6>
                                <div class="border rounded p-3 bg-light">
                                    <div *ngIf="product.attributes && product.attributes.length > 0">
                                        <div *ngFor="let attr of product.attributes; let i = index" class="mb-3 pb-3 border-bottom">
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <label class="form-label">ID del Atributo</label>
                                                    <input type="text"
                                                           class="form-control form-control-sm"
                                                           [(ngModel)]="attr.id"
                                                           [name]="'attr_id_' + i"
                                                           placeholder="Ej: BRAND, MODEL">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Nombre</label>
                                                    <input type="text"
                                                           class="form-control form-control-sm"
                                                           [(ngModel)]="attr.name"
                                                           [name]="'attr_name_' + i"
                                                           placeholder="Ej: Marca">
                                                </div>
                                                <div class="col-md-3">
                                                    <label class="form-label">Valor</label>
                                                    <input type="text"
                                                           class="form-control form-control-sm"
                                                           [(ngModel)]="attr.value_name"
                                                           [name]="'attr_value_' + i"
                                                           placeholder="Ej: Gen√©rica">
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label">&nbsp;</label>
                                                    <button type="button"
                                                            class="btn btn-sm btn-danger w-100"
                                                            (click)="removeAttribute(i)">
                                                        üóëÔ∏è Eliminar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            (click)="addAttribute()">
                                        ‚ûï A√±adir Atributo
                                    </button>
                                </div>
                            </div>

                            <!-- Sale Terms (Warranty) -->
                            <div class="mb-4" *ngIf="product.sale_terms && product.sale_terms.length > 0">
                                <h6 class="mb-3">üõ°Ô∏è Garant√≠a</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tipo de Garant√≠a</label>
                                        <input type="text"
                                               class="form-control"
                                               [(ngModel)]="product.sale_terms[0].value_name"
                                               name="warranty_type_value"
                                               placeholder="Ej: Garant√≠a del vendedor">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Tiempo de Garant√≠a</label>
                                        <input type="text"
                                               class="form-control"
                                               [(ngModel)]="product.sale_terms[1].value_name"
                                               name="warranty_time_value"
                                               placeholder="Ej: 90 d√≠as">
                                    </div>
                                </div>
                            </div>

                            <!-- Pictures URLs -->
                            <div class="mb-3">
                                <label for="pictures" class="form-label">üñºÔ∏è URLs de Im√°genes (opcional)</label>
                                <textarea class="form-control"
                                          id="pictures"
                                          name="pictures_text"
                                          [(ngModel)]="picturesText"
                                          rows="3"
                                          placeholder="http://ejemplo.com/imagen1.jpg&#10;http://ejemplo.com/imagen2.jpg&#10;Una URL por l√≠nea"></textarea>
                                <small class="form-text text-muted">Una URL por l√≠nea. M√°ximo 6 im√°genes.</small>
                            </div>

                            <!-- Shipping Info -->
                            <div class="mb-4" *ngIf="product.shipping">
                                <h6 class="mb-3">üöö Configuraci√≥n de Env√≠o</h6>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Modo de Env√≠o</label>
                                        <input type="text"
                                               class="form-control"
                                               [(ngModel)]="product.shipping.mode"
                                               name="shipping_mode"
                                               placeholder="Ej: me1">
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="form-check mt-4">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   [(ngModel)]="product.shipping.free_shipping"
                                                   name="free_shipping"
                                                   id="freeShipping">
                                            <label class="form-check-label" for="freeShipping">
                                                Env√≠o Gratis
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Tipo Log√≠stico</label>
                                        <input type="text"
                                               class="form-control"
                                               [(ngModel)]="product.shipping.logistic_type"
                                               name="logistic_type"
                                               placeholder="Ej: xd_drop_off">
                                    </div>
                                </div>
                            </div>

                        </div>

                        <!-- Buttons -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <button type="button"
                                    class="btn btn-secondary"
                                    (click)="resetForm()"
                                    [disabled]="loading">
                                üîÑ Resetear
                            </button>
                            <button type="submit"
                                    class="btn btn-warning btn-lg"
                                    [disabled]="!productForm.valid || loading"
                                    style="background-color: #FFE600; border-color: #FFE600; color: #333; font-weight: bold;">
                                <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                                {{ loading ? 'Publicando...' : 'üöÄ Publicar Producto' }}
                            </button>
                        </div>

                    </form>

                </div>
            </div>

            <!-- Info Card -->
            <div class="card mt-3 bg-light">
                <div class="card-body">
                    <h6 class="card-title">‚ÑπÔ∏è Informaci√≥n</h6>
                    <ul class="mb-0 small">
                        <li>Los campos se ajustan autom√°ticamente seg√∫n la categor√≠a seleccionada</li>
                        <li>MercadoLibre genera el t√≠tulo autom√°ticamente bas√°ndose en el nombre y atributos del producto</li>
                        <li>Aseg√∫rate de completar todos los atributos requeridos para evitar errores de validaci√≥n</li>
                        <li>El template se resetea autom√°ticamente despu√©s de publicar exitosamente</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>
